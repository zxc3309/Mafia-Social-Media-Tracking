name: Test Railway Connection

on:
  # å…è¨±æ‰‹å‹•è§¸ç™¼ä»¥æ¸¬è©¦é€£æ¥
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check GitHub Secrets
        run: |
          echo "ğŸ” æª¢æŸ¥ GitHub Secrets é…ç½®..."
          
          # æª¢æŸ¥å¿…è¦çš„ secrets æ˜¯å¦å­˜åœ¨ï¼ˆä¸æœƒé¡¯ç¤ºå¯¦éš›å€¼ï¼‰
          if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "âœ… RAILWAY_TOKEN is configured"
          else
            echo "âŒ RAILWAY_TOKEN is NOT configured"
          fi
          
          if [ -n "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            echo "âœ… RAILWAY_PROJECT_ID is configured"
          else
            echo "âŒ RAILWAY_PROJECT_ID is NOT configured"
          fi
          
          if [ -n "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            echo "âœ… RAILWAY_SERVICE_ID is configured"
          else
            echo "âš ï¸  RAILWAY_SERVICE_ID is NOT configured (optional)"
          fi
      
      - name: Test Railway CLI Installation
        run: |
          echo "ğŸ“¦ å®‰è£ Railway CLI..."
          npm install -g @railway/cli@3.5.2
          echo "âœ… Railway CLI version: $(railway --version)"
      
      - name: Test Railway API Connection
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ğŸ”— æ¸¬è©¦ Railway API é€£æ¥..."
          
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ RAILWAY_TOKEN not found, skipping API test"
            exit 1
          fi
          
          # æ¸¬è©¦ API é€£æ¥ - ç²å–ç”¨æˆ¶ä¿¡æ¯
          response=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"query": "query { me { id email } }"}')
          
          echo "API Response: $response"
          
          if echo "$response" | grep -q "\"id\""; then
            echo "âœ… Railway API é€£æ¥æˆåŠŸ"
          else
            echo "âŒ Railway API é€£æ¥å¤±æ•—"
            exit 1
          fi
      
      - name: Test Railway CLI Authentication
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "ğŸ” æ¸¬è©¦ Railway CLI èªè­‰..."
          
          if [ -z "$RAILWAY_TOKEN" ] || [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "âŒ Missing required environment variables"
            exit 1
          fi
          
          # å˜—è©¦é€£æ¥åˆ°é …ç›®
          echo "ğŸ“¡ Linking to Railway project..."
          railway link $RAILWAY_PROJECT_ID || {
            echo "âŒ Failed to link to Railway project"
            exit 1
          }
          
          echo "âœ… Railway CLI èªè­‰æˆåŠŸ"
      
      - name: List Railway Services
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "ğŸ“‹ åˆ—å‡º Railway æœå‹™..."
          
          # ä½¿ç”¨ API ç²å–é …ç›®æœå‹™åˆ—è¡¨
          response=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"query { project(id: \\\"${RAILWAY_PROJECT_ID}\\\") { services { edges { node { id name } } } } }\"
            }")
          
          echo "Services Response: $response"
          
          # è§£æä¸¦é¡¯ç¤ºæœå‹™ä¿¡æ¯
          if echo "$response" | grep -q "services"; then
            echo "âœ… æˆåŠŸç²å–æœå‹™åˆ—è¡¨"
            echo "ğŸ’¡ æç¤ºï¼šå¦‚æœéœ€è¦ç‰¹å®šæœå‹™ï¼Œè«‹å°‡æœå‹™ ID è¨­ç½®ç‚º RAILWAY_SERVICE_ID secret"
          else
            echo "âš ï¸  ç„¡æ³•ç²å–æœå‹™åˆ—è¡¨ï¼Œä½†é€™å¯èƒ½ä¸å½±éŸ¿åŸ·è¡Œ"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š === æ¸¬è©¦æ‘˜è¦ ==="
          echo ""
          echo "å¦‚æœæ‰€æœ‰æ¸¬è©¦éƒ½é€šéï¼Œæ‚¨çš„ Railway é…ç½®æ­£ç¢ºï¼"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "1. ç¢ºä¿æ‰€æœ‰å¿…è¦çš„ secrets éƒ½å·²é…ç½®"
          echo "2. é‹è¡Œ 'Daily Social Media Collection' workflow é€²è¡Œå¯¦éš›æ¸¬è©¦"
          echo "3. æª¢æŸ¥ Railway æ—¥èªŒä»¥ç¢ºèªåŸ·è¡ŒæˆåŠŸ"
          echo ""
          echo "å¿…éœ€çš„ GitHub Secrets:"
          echo "  - RAILWAY_TOKEN: Railway API Token"
          echo "  - RAILWAY_PROJECT_ID: Railway é …ç›® ID"
          echo "  - RAILWAY_SERVICE_ID: Railway æœå‹™ ID (å¯é¸ä½†å»ºè­°è¨­ç½®)"