name: Fallback Daily Collection

on:
  # 每天早上 9:00 CST (UTC 1:00) 
  schedule:
    - cron: '0 1 * * *'
  # 允許手動觸發
  workflow_dispatch:

jobs:
  trigger-via-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Railway Deployment via API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "🚀 使用 Railway API 觸發部署重啟..."
          
          # 驗證必要的環境變數
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "❌ Error: RAILWAY_TOKEN is not set"
            exit 1
          fi
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "❌ Error: RAILWAY_PROJECT_ID is not set"
            exit 1
          fi
          if [ -z "$RAILWAY_SERVICE_ID" ]; then
            echo "❌ Error: RAILWAY_SERVICE_ID is not set"
            exit 1
          fi
          
          # 方法1: 觸發 GitHub 重新部署（最可靠）
          echo "📡 Method 1: Triggering deployment via GitHub webhook..."
          
          # Railway 會自動從 GitHub 拉取並重新部署
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type":"trigger-railway-collection"}'
          
          echo "✅ GitHub deployment trigger sent"
          echo "⏰ Railway will pull and redeploy automatically"
          echo "📊 Please check Railway logs in 1-2 minutes"
          
          echo "✅ 成功觸發 Railway 服務執行"
      
      - name: Alternative Method - Direct HTTP
        if: failure()
        run: |
          echo "🔄 嘗試備用方法..."
          
          # 使用 webhook 或其他方式觸發
          # 這裡可以添加其他備用觸發方法
          
          echo "📊 請檢查 Railway 日誌確認執行狀態"