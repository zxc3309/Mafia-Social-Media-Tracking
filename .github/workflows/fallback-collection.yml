name: Fallback Daily Collection

on:
  # æ¯å¤©æ—©ä¸Š 9:00 CST (UTC 1:00) 
  schedule:
    - cron: '0 1 * * *'
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  trigger-via-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Railway Deployment via API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "ğŸš€ ä½¿ç”¨ Railway API è§¸ç™¼éƒ¨ç½²é‡å•Ÿ..."
          
          # é©—è­‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ Error: RAILWAY_TOKEN is not set"
            exit 1
          fi
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "âŒ Error: RAILWAY_PROJECT_ID is not set"
            exit 1
          fi
          if [ -z "$RAILWAY_SERVICE_ID" ]; then
            echo "âŒ Error: RAILWAY_SERVICE_ID is not set"
            exit 1
          fi
          
          # ä½¿ç”¨ Railway API v2 è§¸ç™¼æœå‹™é‡æ–°éƒ¨ç½²
          # é€™æœƒé‡æ–°é‹è¡Œ Dockerfile ä¸­çš„ CMDï¼ŒåŸ·è¡Œ main.py --run-once
          echo "ğŸ“¡ Triggering Railway service redeploy..."
          
          response=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"mutation { deploymentRestart(id: \\\"${RAILWAY_SERVICE_ID}\\\") { id } }\"
            }")
          
          echo "API Response: $response"
          
          # æª¢æŸ¥éŸ¿æ‡‰æ˜¯å¦åŒ…å«éŒ¯èª¤
          if echo "$response" | grep -q "errors"; then
            echo "âŒ API èª¿ç”¨å¤±æ•—ï¼Œå˜—è©¦æ›¿ä»£æ–¹æ³•..."
            
            # æ›¿ä»£æ–¹æ³•ï¼šè§¸ç™¼æ–°çš„éƒ¨ç½²
            response=$(curl -s -X POST \
              "https://backboard.railway.app/graphql/v2" \
              -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"query\": \"mutation { deploymentTrigger(projectId: \\\"${RAILWAY_PROJECT_ID}\\\", environmentId: \\\"production\\\", serviceId: \\\"${RAILWAY_SERVICE_ID}\\\") { id } }\"
              }")
            
            echo "Alternative API Response: $response"
            
            if echo "$response" | grep -q "errors"; then
              echo "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—äº†"
              exit 1
            fi
          fi
          
          echo "âœ… æˆåŠŸè§¸ç™¼ Railway æœå‹™åŸ·è¡Œ"
      
      - name: Alternative Method - Direct HTTP
        if: failure()
        run: |
          echo "ğŸ”„ å˜—è©¦å‚™ç”¨æ–¹æ³•..."
          
          # ä½¿ç”¨ webhook æˆ–å…¶ä»–æ–¹å¼è§¸ç™¼
          # é€™è£¡å¯ä»¥æ·»åŠ å…¶ä»–å‚™ç”¨è§¸ç™¼æ–¹æ³•
          
          echo "ğŸ“Š è«‹æª¢æŸ¥ Railway æ—¥èªŒç¢ºèªåŸ·è¡Œç‹€æ…‹"