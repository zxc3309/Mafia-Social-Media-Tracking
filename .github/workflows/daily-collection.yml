name: Daily Social Media Collection

on:
  # 每天早上 9:00 CST (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'
  # 允許手動觸發
  workflow_dispatch:

jobs:
  trigger-collection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Railway CLI
        run: |
          # 安裝特定版本的 Railway CLI 確保一致性
          npm install -g @railway/cli@3.5.2
          echo "Railway CLI version: $(railway --version)"
      
      - name: Execute Collection via Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "🚀 Triggering data collection at $(date)"
          
          # 調試：檢查環境變數
          echo "📊 Debug: Checking environment variables..."
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "❌ Error: RAILWAY_TOKEN is not set in GitHub Secrets"
            exit 1
          else
            echo "✅ RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN})"
          fi
          
          # 設置 Railway 環境
          export RAILWAY_TOKEN="${RAILWAY_TOKEN}"
          
          # 方法1: 使用 railway login 和 project link
          echo "🔐 Method 1: Using railway login..."
          railway login --browserless 2>/dev/null || echo "⚠️ Login command not available in this version"
          
          # 方法2: 直接使用 railway run with project flag
          echo "🔄 Method 2: Direct execution with project flag..."
          railway run \
            --project "${{ secrets.RAILWAY_PROJECT_ID }}" \
            --environment "production" \
            --service "${{ secrets.RAILWAY_SERVICE_ID }}" \
            -- python main.py --run-once \
          || {
            echo "❌ Method 2 failed, trying Method 3..."
            
            # 方法3: 使用 railway 命令而不帶 run
            echo "🔄 Method 3: Using railway exec..."
            railway exec \
              --project "${{ secrets.RAILWAY_PROJECT_ID }}" \
              --service "${{ secrets.RAILWAY_SERVICE_ID }}" \
              python main.py --run-once
          } || {
            echo "❌ All Railway CLI methods failed"
            echo "📝 Railway CLI may not support remote execution in GitHub Actions"
            echo "💡 Please use the Fallback Collection workflow instead"
            exit 1
          }
          
          echo "✅ Collection task completed at $(date)"
      
      - name: Check Collection Status
        run: |
          echo "📊 Collection executed successfully"
          echo "Please check Railway logs and Google Sheets for results"