name: Daily Social Media Collection

on:
  # æ¯å¤©æ—©ä¸Š 9:00 CST (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  trigger-collection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Railway CLI
        run: |
          # å®‰è£ç‰¹å®šç‰ˆæœ¬çš„ Railway CLI ç¢ºä¿ä¸€è‡´æ€§
          npm install -g @railway/cli@3.5.2
          echo "Railway CLI version: $(railway --version)"
      
      - name: Execute Collection via Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ğŸš€ Triggering data collection at $(date)"
          
          # èª¿è©¦ï¼šæª¢æŸ¥ç’°å¢ƒè®Šæ•¸
          echo "ğŸ“Š Debug: Checking environment variables..."
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ Error: RAILWAY_TOKEN is not set in GitHub Secrets"
            exit 1
          else
            echo "âœ… RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN})"
          fi
          
          # è¨­ç½® Railway ç’°å¢ƒ
          export RAILWAY_TOKEN="${RAILWAY_TOKEN}"
          
          # æ–¹æ³•1: ä½¿ç”¨ railway login å’Œ project link
          echo "ğŸ” Method 1: Using railway login..."
          railway login --browserless 2>/dev/null || echo "âš ï¸ Login command not available in this version"
          
          # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ railway run with project flag
          echo "ğŸ”„ Method 2: Direct execution with project flag..."
          railway run \
            --project "${{ secrets.RAILWAY_PROJECT_ID }}" \
            --environment "production" \
            --service "${{ secrets.RAILWAY_SERVICE_ID }}" \
            -- python main.py --run-once \
          || {
            echo "âŒ Method 2 failed, trying Method 3..."
            
            # æ–¹æ³•3: ä½¿ç”¨ railway å‘½ä»¤è€Œä¸å¸¶ run
            echo "ğŸ”„ Method 3: Using railway exec..."
            railway exec \
              --project "${{ secrets.RAILWAY_PROJECT_ID }}" \
              --service "${{ secrets.RAILWAY_SERVICE_ID }}" \
              python main.py --run-once
          } || {
            echo "âŒ All Railway CLI methods failed"
            echo "ğŸ“ Railway CLI may not support remote execution in GitHub Actions"
            echo "ğŸ’¡ Please use the Fallback Collection workflow instead"
            exit 1
          }
          
          echo "âœ… Collection task completed at $(date)"
      
      - name: Check Collection Status
        run: |
          echo "ğŸ“Š Collection executed successfully"
          echo "Please check Railway logs and Google Sheets for results"