name: Simple Railway Trigger

on:
  # 每天早上 9:00 CST (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'
  # 允許手動觸發
  workflow_dispatch:

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Railway Deployment
        run: |
          echo "🚀 Triggering Railway deployment at $(date)"
          
          # 使用 curl 觸發 Railway 部署 webhook
          # Railway 會重新運行 Dockerfile，執行 main.py --run-once
          
          # 方法 1: 使用 Railway Deployment Webhook (如果已設置)
          if [ -n "${{ secrets.RAILWAY_WEBHOOK_URL }}" ]; then
            echo "📡 Using Railway Webhook..."
            curl -X POST "${{ secrets.RAILWAY_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"trigger": "daily-collection"}'
            echo "✅ Webhook triggered"
          else
            echo "⚠️ No webhook configured, using API method..."
            
            # 方法 2: 使用 GitHub API 觸發重新部署
            # 這會觸發 Railway 從 GitHub 拉取最新代碼並重新部署
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/dispatches" \
              -d '{"event_type":"railway-deploy"}'
            
            echo "✅ Deployment trigger sent via GitHub"
          fi
          
          echo "📊 Check Railway logs for execution status"
      
      - name: Alternative - Use Railway GraphQL API
        if: failure()
        run: |
          echo "🔄 Trying Railway GraphQL API..."
          
          # 創建一個新的部署來觸發執行
          curl -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { deploymentCreate(input: { projectId: \"${{ secrets.RAILWAY_PROJECT_ID }}\", environmentId: \"production\", serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\" }) { id } }"
            }'
          
          echo "✅ Deployment created via API"