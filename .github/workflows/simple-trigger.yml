name: Simple Railway Trigger

on:
  # æ¯å¤©æ—©ä¸Š 9:00 CST (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Railway Deployment
        run: |
          echo "ğŸš€ Triggering Railway deployment at $(date)"
          
          # ä½¿ç”¨ curl è§¸ç™¼ Railway éƒ¨ç½² webhook
          # Railway æœƒé‡æ–°é‹è¡Œ Dockerfileï¼ŒåŸ·è¡Œ main.py --run-once
          
          # æ–¹æ³• 1: ä½¿ç”¨ Railway Deployment Webhook (å¦‚æœå·²è¨­ç½®)
          if [ -n "${{ secrets.RAILWAY_WEBHOOK_URL }}" ]; then
            echo "ğŸ“¡ Using Railway Webhook..."
            curl -X POST "${{ secrets.RAILWAY_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"trigger": "daily-collection"}'
            echo "âœ… Webhook triggered"
          else
            echo "âš ï¸ No webhook configured, using API method..."
            
            # æ–¹æ³• 2: ä½¿ç”¨ GitHub API è§¸ç™¼é‡æ–°éƒ¨ç½²
            # é€™æœƒè§¸ç™¼ Railway å¾ GitHub æ‹‰å–æœ€æ–°ä»£ç¢¼ä¸¦é‡æ–°éƒ¨ç½²
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/dispatches" \
              -d '{"event_type":"railway-deploy"}'
            
            echo "âœ… Deployment trigger sent via GitHub"
          fi
          
          echo "ğŸ“Š Check Railway logs for execution status"
      
      - name: Alternative - Use Railway GraphQL API
        if: failure()
        run: |
          echo "ğŸ”„ Trying Railway GraphQL API..."
          
          # å‰µå»ºä¸€å€‹æ–°çš„éƒ¨ç½²ä¾†è§¸ç™¼åŸ·è¡Œ
          curl -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { deploymentCreate(input: { projectId: \"${{ secrets.RAILWAY_PROJECT_ID }}\", environmentId: \"production\", serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\" }) { id } }"
            }'
          
          echo "âœ… Deployment created via API"