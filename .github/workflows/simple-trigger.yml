name: Simple Railway Trigger

on:
  # 每天早上 9:00 CST (UTC 1:00)
  schedule:
    - cron: '0 1 * * *'
  # 允許手動觸發
  workflow_dispatch:

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Railway Deployment
        run: |
          echo "🚀 Triggering Railway deployment at $(date)"
          
          # 直接使用 GitHub API 觸發 repository dispatch
          # 這個方法第一次成功過
          echo "📡 Sending deployment trigger via GitHub..."
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type":"trigger-railway-collection"}'
          
          echo "✅ GitHub dispatch event sent"
          
          # 給 Railway 一些時間來檢測變更
          echo "⏰ Waiting for Railway to detect changes..."
          sleep 5
          
          echo "📊 Deployment should start soon. Check Railway logs for status"
          echo "💡 Note: Railway may take 1-2 minutes to start the deployment"
      
      - name: Alternative - Use Railway GraphQL API
        if: failure()
        run: |
          echo "🔄 Trying Railway GraphQL API..."
          
          # 創建一個新的部署來觸發執行
          curl -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { deploymentCreate(input: { projectId: \"${{ secrets.RAILWAY_PROJECT_ID }}\", environmentId: \"production\", serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\" }) { id } }"
            }'
          
          echo "✅ Deployment created via API"