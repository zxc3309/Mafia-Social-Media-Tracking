name: Debug Railway Connection

on:
  workflow_dispatch:

jobs:
  debug-railway:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Secrets
        run: |
          echo "🔍 檢查 Secrets 配置..."
          echo "RAILWAY_TOKEN length: ${#RAILWAY_TOKEN}"
          echo "RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}"
          echo "RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Install Railway CLI
        run: |
          echo "📦 安裝 Railway CLI..."
          npm install -g @railway/cli
          railway --version
      
      - name: Test Railway Connection
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "🔌 測試 Railway 連接..."
          echo "Token length: ${#RAILWAY_TOKEN}"
          
          # 測試基本連接
          if [ -n "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            echo "使用 Service ID: ${{ secrets.RAILWAY_SERVICE_ID }}"
            railway whoami || echo "認證失敗"
          elif [ -n "${{ secrets.RAILWAY_ENVIRONMENT_ID }}" ]; then
            echo "使用 Environment ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}"
            railway whoami || echo "認證失敗"
          else
            echo "❌ 缺少 RAILWAY_SERVICE_ID 或 RAILWAY_ENVIRONMENT_ID"
          fi
      
      - name: Test Simple Command
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "🧪 測試簡單命令..."
          if [ -n "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            railway run echo "Railway connection successful!" --service ${{ secrets.RAILWAY_SERVICE_ID }}
          else
            railway run echo "Railway connection successful!"
          fi